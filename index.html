
<!DOCTYPE html>
<html class="light" dir="rtl" lang="he">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gemini Transcriber Pro</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#135bec", 
                    "background-light": "#f6f6f8",
                    "background-dark": "#101622",
                    "surface-dark": "#192233",
                    "border-dark": "#324467"
                },
                fontFamily: {
                    "display": ["Heebo", "Inter", "sans-serif"],
                    "body": ["Heebo", "Inter", "sans-serif"]
                },
            },
        },
    }
</script>
<style>
    body { font-family: 'Heebo', sans-serif; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #324467; }

    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    
    .paper-canvas {
        min-height: 800px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .dark .paper-canvas {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
    }

    .nav-link.active {
        color: #135bec;
        border-bottom: 2px solid #135bec;
    }
    .dark .nav-link.active {
        color: #3b82f6;
        border-bottom: 2px solid #3b82f6;
    }

    /* Toast Animation */
    @keyframes slideIn {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    .toast-enter { animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
    .toast-exit { animation: fadeOut 0.3s ease-out forwards; }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white transition-colors duration-200 flex flex-col min-h-screen">

<!-- Header Unified -->
<header class="sticky top-0 z-50 bg-white dark:bg-background-dark border-b border-slate-200 dark:border-border-dark px-4 md:px-10 py-3 shadow-sm">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <!-- Logo -->
        <div class="flex items-center gap-3">
            <div class="size-8 text-primary bg-primary/10 rounded-lg flex items-center justify-center">
                <span class="material-symbols-outlined">graphic_eq</span>
            </div>
            <h2 class="text-slate-900 dark:text-white text-lg font-bold tracking-tight hidden md:block">Gemini Transcriber Pro</h2>
        </div>

        <!-- Navigation Tabs -->
        <nav class="flex items-center gap-6 md:gap-9">
            <button onclick="switchTab('creation')" id="btn-creation" class="nav-link active text-sm font-bold py-2 transition-colors">יצירה</button>
            <button onclick="switchTab('editor')" id="btn-editor" class="nav-link text-slate-500 dark:text-slate-400 text-sm font-medium py-2 hover:text-primary transition-colors">עורך</button>
            <button onclick="switchTab('archive')" id="btn-archive" class="nav-link text-slate-500 dark:text-slate-400 text-sm font-medium py-2 hover:text-primary transition-colors">ארכיון</button>
        </nav>

        <!-- User/Theme Actions -->
        <div class="flex items-center gap-3">
            <div class="hidden md:flex text-xs text-slate-400 bg-slate-100 dark:bg-surface-dark px-2 py-1 rounded gap-2 mr-2">
                <span>Ctrl+S שמירה</span>
                <span>Ctrl+Space נגן</span>
            </div>
            <button onclick="toggleTheme()" class="flex items-center justify-center rounded-lg size-10 bg-slate-100 dark:bg-surface-dark text-slate-700 dark:text-white hover:bg-slate-200 dark:hover:border-dark transition-all">
                <span id="themeIcon" class="material-symbols-outlined text-[20px]">dark_mode</span>
            </button>
            <div class="size-9 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden border border-slate-300 dark:border-border-dark">
                <img alt="User" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-full h-full" />
            </div>
        </div>
    </div>
</header>

<main class="flex-1 w-full max-w-7xl mx-auto p-4 md:p-8">

    <!-- VIEW 1: CREATION (DASHBOARD) -->
    <div id="view-creation" class="animate-fade-in max-w-4xl mx-auto">
        <!-- Settings Bar -->
        <section class="bg-white dark:bg-surface-dark rounded-xl p-6 border border-slate-200 dark:border-border-dark mb-8 shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <label class="flex flex-col gap-2">
                    <p class="text-slate-700 dark:text-white text-sm font-medium">מפתח API (Gemini)</p>
                    <div class="relative">
                        <input id="apiKey" class="w-full rounded-lg border-slate-200 dark:border-border-dark bg-slate-50 dark:bg-[#111722] text-slate-900 dark:text-white focus:ring-primary focus:border-primary h-11 px-4 text-sm" placeholder="הדבק כאן את המפתח..." type="password"/>
                        <span onclick="toggleKeyVisibility()" class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer text-[20px] hover:text-primary">visibility</span>
                    </div>
                </label>
                <label class="flex flex-col gap-2">
                    <p class="text-slate-700 dark:text-white text-sm font-medium">בחירת מודל</p>
                    <div class="flex gap-2">
                        <select id="modelSelect" class="w-full rounded-lg border-slate-200 dark:border-border-dark bg-slate-50 dark:bg-[#111722] text-slate-900 dark:text-white focus:ring-primary focus:border-primary h-11 px-4 text-sm">
                            <option value="" disabled selected>טען מודלים...</option>
                        </select>
                        <button onclick="fetchModels()" id="loadModelsBtn" class="bg-slate-100 dark:bg-border-dark rounded-lg px-3 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors" title="רענן מודלים">
                            <span class="material-symbols-outlined text-lg">sync</span>
                        </button>
                    </div>
                </label>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <p class="text-slate-700 dark:text-white text-sm font-medium">יצירתיות (Temp)</p>
                        <p id="tempValue" class="text-primary text-xs font-bold">0.3</p>
                    </div>
                    <input type="range" id="tempInput" min="0" max="1.5" step="0.1" value="0.3" oninput="document.getElementById('tempValue').innerText = this.value" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-border-dark accent-primary">
                </div>
            </div>
        </section>

        <!-- Media Source Header -->
        <div class="flex items-center justify-between px-2 pb-4">
            <h3 class="text-slate-900 dark:text-white text-xl font-bold tracking-tight">מקור מדיה</h3>
            <span class="text-xs text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-surface-dark px-2 py-1 rounded">תומך: MP3, WAV, MP4 (עד 2GB)</span>
        </div>

        <!-- Dual Input Zone -->
        <input type="file" id="hiddenFileInput" class="hidden" accept="audio/*,video/*">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Drag & Drop -->
            <div id="dropZone" class="md:col-span-3 flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-slate-300 dark:border-border-dark bg-white dark:bg-surface-dark px-6 py-10 transition-all hover:border-primary/50 group cursor-pointer hover:bg-slate-50 dark:hover:bg-[#1e293b]">
                <div class="flex flex-col items-center gap-4">
                    <div class="size-14 rounded-full bg-primary/10 flex items-center justify-center text-primary group-hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined text-[32px]">upload_file</span>
                    </div>
                    <div class="text-center">
                        <p id="fileNameDisplay" class="text-slate-900 dark:text-white text-lg font-bold">גרור קובץ לכאן</p>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">או לחץ כדי לבחור מהמחשב</p>
                    </div>
                </div>
            </div>
            
            <!-- Record Button Zone with Visualizer -->
            <div id="recordBtn" onclick="toggleRecording(event)" class="relative overflow-hidden flex flex-col items-center justify-center rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-surface-dark px-4 py-8 hover:shadow-md transition-shadow cursor-pointer hover:border-red-200 dark:hover:border-red-900/50">
                
                <!-- Default Icon State -->
                <div id="micIconContainer" class="size-16 rounded-full bg-red-500/10 flex items-center justify-center text-red-500 mb-4 transition-transform hover:scale-105">
                    <span class="material-symbols-outlined text-[32px]">mic</span>
                </div>

                <!-- Visualizer Canvas (Hidden initially) -->
                <canvas id="visualizer" width="200" height="80" class="hidden absolute top-4 left-1/2 -translate-x-1/2 z-10 w-[90%] h-[80px] rounded-lg"></canvas>

                <p id="recordLabel" class="text-slate-900 dark:text-white font-bold relative z-20">הקלטה חיה</p>
                
                <button id="recordActionBtn" class="mt-4 w-full py-2.5 rounded-lg bg-red-500 hover:bg-red-600 text-white font-bold text-xs transition-colors shadow-lg shadow-red-500/20 relative z-20">
                    <span id="recordText">התחל להקליט</span>
                </button>
            </div>
        </div>

        <!-- Preview Area (Hidden by default) -->
        <div id="previewContainer" class="hidden mb-8 bg-black/5 dark:bg-black/40 rounded-xl p-4 border border-slate-200 dark:border-border-dark">
            <video id="filePreview" controls class="w-full rounded-lg max-h-[300px] bg-black"></video>
        </div>

        <!-- Inputs Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
            <div class="flex flex-col gap-4">
                <label class="flex flex-col gap-2">
                    <p class="text-slate-900 dark:text-white text-base font-bold flex items-center gap-2">
                        הקשר (Context)
                        <span class="material-symbols-outlined text-[16px] text-slate-400" title="עוזר למודל להבין את הנושא">info</span>
                    </p>
                    <textarea id="contextInput" class="w-full min-h-[120px] rounded-xl border-slate-200 dark:border-border-dark bg-white dark:bg-surface-dark text-slate-900 dark:text-white focus:ring-primary focus:border-primary p-4 text-sm resize-none custom-scrollbar" placeholder="לדוגמה: זוהי שיחה משפטית בין עורך דין ללקוח בנושא קניין רוחני. מונחים חשובים: 'פטנט', 'הפרה', 'בית משפט מחוזי'."></textarea>
                </label>
                <label class="flex flex-col gap-2 w-full">
                    <p class="text-slate-900 dark:text-white text-base font-bold">מספר דוברים משוער</p>
                    <input id="speakerCount" class="w-full rounded-xl border-slate-200 dark:border-border-dark bg-white dark:bg-surface-dark text-slate-900 dark:text-white font-bold h-11 px-4 text-center" type="number" placeholder="אוטומטי" min="1" max="10"/>
                </label>
            </div>
            <div class="flex flex-col gap-2">
                <p class="text-slate-900 dark:text-white text-base font-bold flex items-center gap-2">
                   הנחיה למודל (Prompt)
                </p>
                <textarea id="promptInput" class="w-full h-full min-h-[180px] rounded-xl border-slate-200 dark:border-border-dark bg-white dark:bg-surface-dark text-slate-900 dark:text-white focus:ring-primary focus:border-primary p-4 text-sm resize-none custom-scrollbar" placeholder="לדוגמה: תמלל את השיחה בעברית רשמית. ציין את שמות הדוברים בתחילת כל משפט. הוסף חותמות זמן כל דקה."></textarea>
            </div>
        </section>

        <!-- Process Status -->
        <div id="processSection" class="hidden mb-8 bg-white dark:bg-surface-dark rounded-xl p-6 border border-slate-200 dark:border-border-dark">
            <div class="flex justify-between items-center mb-2">
                <span id="statusText" class="text-sm font-bold text-primary">מעבד...</span>
                <button onclick="cancelProcess()" class="text-xs text-red-500 font-bold hover:underline">ביטול</button>
            </div>
            <div class="w-full bg-slate-100 dark:bg-[#111722] rounded-full h-2.5">
                <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="flex flex-col gap-4 py-8 border-t border-slate-200 dark:border-border-dark items-center">
            <button id="runBtn" onclick="runTranscriptionProcess()" class="flex w-full max-w-[400px] cursor-pointer items-center justify-center rounded-xl h-14 bg-primary text-white gap-3 text-lg font-bold shadow-lg shadow-primary/25 hover:bg-blue-600 hover:scale-[1.01] transition-all">
                <span class="material-symbols-outlined text-[24px]">rocket_launch</span>
                התחל תמלול
            </button>
            <p class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1.5">
                <span class="material-symbols-outlined text-[14px]">shield</span>
                המידע מעובד בצורה מאובטחת דרך Gemini API ואינו נשמר בשרתים שלנו.
            </p>
        </div>
    </div>

    <!-- VIEW 2: EDITOR -->
    <div id="view-editor" class="hidden animate-fade-in">
        <!-- Editor Header -->
        <div class="flex flex-wrap items-center justify-between gap-4 py-4 mb-4">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-gray-400 text-3xl">description</span>
                <h1 id="currentFileName" class="text-slate-900 dark:text-white text-2xl font-bold truncate max-w-md">מסמך חדש</h1>
            </div>
            <div class="flex gap-3">
                <button onclick="copyToClipboard()" class="flex min-w-[100px] items-center justify-center rounded-lg h-10 px-4 bg-white dark:bg-surface-dark border border-slate-200 dark:border-border-dark text-slate-700 dark:text-white text-sm font-semibold hover:bg-slate-50 dark:hover:bg-slate-800 transition-all gap-2">
                    <span class="material-symbols-outlined text-[18px]">content_copy</span>
                    <span>העתק</span>
                </button>
                <button onclick="downloadText()" class="flex min-w-[100px] items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-semibold shadow-md hover:bg-blue-700 transition-all gap-2">
                    <span class="material-symbols-outlined text-[18px]">download</span>
                    <span>הורד</span>
                </button>
            </div>
        </div>

        <!-- Sticky Toolbar -->
        <div class="sticky top-[70px] z-40 w-full flex justify-center mb-8">
            <div class="w-full max-w-4xl flex flex-wrap justify-between gap-2 px-4 py-2 bg-white dark:bg-surface-dark rounded-xl shadow-lg border border-slate-100 dark:border-border-dark">
                <div class="flex gap-1 items-center flex-wrap">
                    <button onclick="formatDoc('bold')" class="p-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-primary/5 rounded"><span class="material-symbols-outlined">format_bold</span></button>
                    <button onclick="formatDoc('italic')" class="p-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-primary/5 rounded"><span class="material-symbols-outlined">format_italic</span></button>
                    <button onclick="formatDoc('underline')" class="p-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-primary/5 rounded"><span class="material-symbols-outlined">format_underlined</span></button>
                    <div class="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1"></div>
                    <button onclick="formatDoc('justifyRight')" class="p-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-primary/5 rounded"><span class="material-symbols-outlined">format_align_right</span></button>
                    <button onclick="formatDoc('justifyCenter')" class="p-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-primary/5 rounded"><span class="material-symbols-outlined">format_align_center</span></button>
                    <button onclick="formatDoc('justifyLeft')" class="p-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-primary/5 rounded"><span class="material-symbols-outlined">format_align_left</span></button>
                    <div class="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1"></div>
                    <button onclick="formatDoc('formatBlock', 'H2')" class="p-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-primary/5 rounded font-bold">H2</button>
                    <button onclick="formatDoc('insertUnorderedList')" class="p-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-primary/5 rounded"><span class="material-symbols-outlined">format_list_bulleted</span></button>
                </div>
                <div class="relative w-64 hidden md:block">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[20px] cursor-pointer" onclick="findNext()">search</span>
                    <input id="findInput" class="w-full pl-10 pr-4 h-9 bg-slate-50 dark:bg-[#111722] border-none rounded-lg text-sm focus:ring-1 focus:ring-primary text-slate-900 dark:text-white" placeholder="חיפוש בטקסט..." type="text"/>
                </div>
            </div>
        </div>

        <!-- Canvas -->
        <div class="w-full flex justify-center pb-20 relative">
            <div id="outputArea" contenteditable="true" oninput="updateEditorStats(); autoSave()" class="paper-canvas w-full max-w-[840px] bg-white dark:bg-surface-dark rounded-sm p-12 md:p-16 text-slate-800 dark:text-slate-200 text-lg leading-relaxed outline-none whitespace-pre-wrap">
                <p class="text-slate-400 italic text-center mt-20">הטקסט המתומלל יופיע כאן לעריכה...</p>
            </div>
            
            <!-- Floating Status -->
            <div class="fixed bottom-6 z-30">
                <div class="bg-white/90 dark:bg-surface-dark/90 backdrop-blur-md px-6 py-2 rounded-full shadow-lg border border-slate-200 dark:border-border-dark flex items-center gap-6 text-sm font-medium text-slate-500 dark:text-slate-400">
                    <div class="flex items-center gap-2">
                        <span id="saveStatusIcon" class="material-symbols-outlined text-[18px] text-green-500">check_circle</span>
                        <span id="saveStatusText">נשמר בענן</span>
                    </div>
                    <div class="h-4 w-px bg-slate-200 dark:bg-slate-700"></div>
                    <span id="wordCount">0 מילים</span>
                    <span id="charCount">0 תווים</span>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 3: ARCHIVE -->
    <div id="view-archive" class="hidden animate-fade-in">
        <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
            <div class="flex flex-col gap-1">
                <h1 class="text-slate-900 dark:text-white text-3xl font-black">היסטוריית תמלולים</h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm">נהל וצפה בכל ההקלטות והמסמכים הקודמים שלך.</p>
            </div>
            <button onclick="clearAllHistory()" class="flex items-center gap-2 px-4 py-2 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-100 transition-colors text-sm font-bold border border-red-100 dark:border-red-900/30">
                <span class="material-symbols-outlined text-lg">delete_sweep</span>
                מחק הכל
            </button>
        </div>

        <!-- Archive Table -->
        <div class="overflow-hidden rounded-xl border border-slate-200 dark:border-border-dark bg-white dark:bg-surface-dark shadow-sm">
            <table class="w-full text-right">
                <thead class="bg-slate-50 dark:bg-[#111722]">
                    <tr>
                        <th class="px-6 py-4 text-slate-900 dark:text-white text-sm font-semibold">שם הקובץ</th>
                        <th class="px-6 py-4 text-slate-900 dark:text-white text-sm font-semibold">תאריך</th>
                        <th class="px-6 py-4 text-slate-900 dark:text-white text-sm font-semibold hidden md:table-cell">תצוגה מקדימה</th>
                        <th class="px-6 py-4 text-slate-900 dark:text-white text-sm font-semibold w-24">פעולות</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                    <!-- שורות יתווספו דינמית -->
                    <tr>
                        <td colspan="4" class="px-6 py-10 text-center text-slate-500">
                            <span class="material-symbols-outlined text-4xl mb-2">inventory_2</span>
                            <p>הארכיון ריק כרגע</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</main>

<!-- Toast Container -->
<div id="toast-container" class="fixed bottom-5 left-5 z-[100] flex flex-col gap-3 pointer-events-none"></div>

<script>
// --- Configuration & Globals ---
const BASE_URL = "https://generativelanguage.googleapis.com";
let fileCache = JSON.parse(localStorage.getItem('gemini_file_cache') || '{}');
let abortController = null;
let mediaRecorder = null;
let audioChunks = [];
let selectedFile = null;
let currentDocId = null;
let saveTimeout;

// Audio Visualizer Globals
let audioCtx;
let analyser;
let visualizerDataArray;
let visualizerCanvasCtx;
let visualizerReqId;

// --- Toast Notification System ---
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    // Config based on type
    const configs = {
        success: { icon: 'check_circle', bg: 'bg-green-500', text: 'text-white' },
        error:   { icon: 'error', bg: 'bg-red-500', text: 'text-white' },
        info:    { icon: 'info', bg: 'bg-blue-500', text: 'text-white' },
        warning: { icon: 'warning', bg: 'bg-amber-500', text: 'text-white' }
    };
    const config = configs[type] || configs.info;

    toast.className = `toast-enter flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg ${config.bg} ${config.text} min-w-[250px] max-w-[350px] pointer-events-auto`;
    toast.innerHTML = `
        <span class="material-symbols-outlined">${config.icon}</span>
        <span class="text-sm font-medium flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="opacity-70 hover:opacity-100"><span class="material-symbols-outlined text-lg">close</span></button>
    `;

    container.appendChild(toast);

    // Auto remove
    setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        toast.addEventListener('animationend', () => toast.remove());
    }, 4000);
}

// --- Keyboard Shortcuts ---
document.addEventListener('keydown', (e) => {
    // Ctrl+S: Save
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        const editorView = document.getElementById('view-editor');
        if(!editorView.classList.contains('hidden')) {
            clearTimeout(saveTimeout);
            autoSave(true); // true = force immediate visual feedback
        }
    }
    
    // Ctrl+Space: Play/Pause
    if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
        e.preventDefault();
        const video = document.getElementById('filePreview');
        if (video && video.src) {
            video.paused ? video.play() : video.pause();
            showToast(video.paused ? "הושהה" : "מנגן", "info");
        }
    }

    // Esc: Cancel Process / Modals (Future)
    if (e.key === 'Escape') {
        const processSec = document.getElementById('processSection');
        if(!processSec.classList.contains('hidden')) {
            cancelProcess();
        }
    }
});

// --- Tab Management ---
function switchTab(tabId) {
    // Hide all views
    document.getElementById('view-creation').classList.add('hidden');
    document.getElementById('view-editor').classList.add('hidden');
    document.getElementById('view-archive').classList.add('hidden');
    
    // Deactivate all buttons
    document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active', 'text-primary'));
    
    // Show selected view
    document.getElementById('view-' + tabId).classList.remove('hidden');
    document.getElementById('btn-' + tabId).classList.add('active');
    
    // Actions based on tab
    if(tabId === 'archive') renderHistory();
    if(tabId === 'editor') updateEditorStats();
}

// --- Theme Management ---
function toggleTheme() {
    const html = document.documentElement;
    if (html.classList.contains('dark')) {
        html.classList.remove('dark');
        localStorage.setItem('theme', 'light');
    } else {
        html.classList.add('dark');
        localStorage.setItem('theme', 'dark');
    }
}

function initTheme() {
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
}

function toggleKeyVisibility() {
    const input = document.getElementById('apiKey');
    input.type = input.type === "password" ? "text" : "password";
}

// --- IndexedDB (Storage) ---
const DB_NAME = 'GeminiTranscriberDB';
const DB_VERSION = 1;
const STORE_NAME = 'transcriptions';

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject("DB Error");
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
        };
        request.onsuccess = (e) => resolve(e.target.result);
    });
}

async function saveToDB(filename, fullText, existingId = null) {
    const db = await openDB();
    const tx = db.transaction([STORE_NAME], "readwrite");
    const store = tx.objectStore(STORE_NAME);
    const item = {
        id: existingId || Date.now(),
        filename: filename,
        date: new Date().toLocaleString('he-IL'),
        text: fullText,
        preview: fullText.replace(/<[^>]*>/g, '').substring(0, 100) + "..."
    };
    store.put(item);
    return item.id;
}

async function getAllFromDB() {
    const db = await openDB();
    return new Promise((resolve) => {
        const tx = db.transaction([STORE_NAME], "readonly");
        const req = tx.objectStore(STORE_NAME).getAll();
        req.onsuccess = () => resolve(req.result);
    });
}

async function deleteFromDB(id) {
    if(!confirm("למחוק את התמלול הזה לצמיתות?")) return;
    const db = await openDB();
    const tx = db.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).delete(id);
    await tx.complete;
    showToast("נמחק בהצלחה", "success");
    renderHistory();
}

async function clearAllHistory() {
    if(!confirm("זהירות: כל ההיסטוריה תימחק. להמשיך?")) return;
    const db = await openDB();
    const tx = db.transaction([STORE_NAME], "readwrite");
    tx.objectStore(STORE_NAME).clear();
    await tx.complete;
    showToast("הארכיון נוקה", "success");
    renderHistory();
}

// --- Editor Logic ---
function formatDoc(cmd, value = null) {
    document.execCommand(cmd, false, value);
    document.getElementById('outputArea').focus();
}

function updateEditorStats() {
    const text = document.getElementById('outputArea').innerText || "";
    const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
    document.getElementById('wordCount').innerText = words + " מילים";
    document.getElementById('charCount').innerText = text.length + " תווים";
}

function autoSave(force = false) {
    const statusText = document.getElementById('saveStatusText');
    const statusIcon = document.getElementById('saveStatusIcon');
    statusText.innerText = "שומר...";
    statusIcon.className = "material-symbols-outlined text-[18px] text-yellow-500 animate-spin";
    statusIcon.innerText = "sync";

    const performSave = async () => {
        const text = document.getElementById('outputArea').innerHTML;
        const filename = document.getElementById('currentFileName').innerText;
        if(!currentDocId) currentDocId = Date.now();
        await saveToDB(filename, text, currentDocId);
        
        statusText.innerText = "נשמר בענן";
        statusIcon.className = "material-symbols-outlined text-[18px] text-green-500";
        statusIcon.innerText = "check_circle";
        if(force) showToast("המסמך נשמר", "success");
    };

    if(force) {
        performSave();
    } else {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(performSave, 1000);
    }
}

function findNext() {
    const query = document.getElementById('findInput').value;
    if (query && window.find) {
        const found = window.find(query);
        if(!found) showToast("לא נמצאו תוצאות נוספות", "warning");
    }
}

// --- Archive Render (Table) ---
async function renderHistory() {
    const tbody = document.getElementById('historyTableBody');
    try {
        let history = await getAllFromDB();
        history.sort((a, b) => b.id - a.id);
        tbody.innerHTML = '';
        
        if(history.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-10 text-center text-slate-500 dark:text-slate-400"><span class="material-symbols-outlined text-4xl mb-2">inventory_2</span><p>הארכיון ריק כרגע</p></td></tr>`;
            return;
        }

        history.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = "group hover:bg-primary/[0.02] dark:hover:bg-primary/[0.05] transition-colors border-b border-slate-50 dark:border-slate-800 last:border-0";
            tr.innerHTML = `
                <td class="px-6 py-4 cursor-pointer" onclick="loadDoc(${item.id})">
                    <div class="flex items-center gap-3">
                        <div class="text-primary flex items-center justify-center rounded-lg bg-primary/10 shrink-0 size-10">
                            <span class="material-symbols-outlined">description</span>
                        </div>
                        <span class="text-slate-900 dark:text-white text-sm font-bold">${item.filename}</span>
                    </div>
                </td>
                <td class="px-6 py-4 cursor-pointer" onclick="loadDoc(${item.id})">
                    <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">${item.date}</p>
                </td>
                <td class="px-6 py-4 hidden md:table-cell cursor-pointer" onclick="loadDoc(${item.id})">
                    <p class="text-slate-500 dark:text-slate-400 text-sm italic line-clamp-1">${item.preview}</p>
                </td>
                <td class="px-6 py-4 text-left">
                    <button onclick="event.stopPropagation(); deleteFromDB(${item.id})" class="text-slate-400 hover:text-red-500 transition-colors p-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20" title="מחק רשומה">
                        <span class="material-symbols-outlined text-xl">delete</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch(e) { console.error(e); }
}

async function loadDoc(id) {
    const db = await openDB();
    const tx = db.transaction([STORE_NAME], "readonly");
    const req = tx.objectStore(STORE_NAME).get(id);
    req.onsuccess = () => {
        const item = req.result;
        if(item) {
            currentDocId = item.id;
            document.getElementById('outputArea').innerHTML = item.text;
            document.getElementById('currentFileName').innerText = item.filename;
            switchTab('editor');
            showToast("מסמך נטען", "info");
        }
    };
}

// --- Gemini & File Logic ---

// Drag & Drop
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('hiddenFileInput');

dropZone.addEventListener('click', (e) => { if(!e.target.closest('button')) fileInput.click(); });
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-primary', 'bg-primary/5'); });
dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-primary', 'bg-primary/5'); });
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-primary', 'bg-primary/5');
    if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => { if(fileInput.files.length) handleFile(fileInput.files[0]); });

function handleFile(file) {
    selectedFile = file;
    document.getElementById('fileNameDisplay').textContent = file.name;
    document.getElementById('fileNameDisplay').classList.add('text-primary');
    
    // Preview
    const url = URL.createObjectURL(file);
    const video = document.getElementById('filePreview');
    video.src = url;
    document.getElementById('previewContainer').classList.remove('hidden');
    showToast("קובץ נטען בהצלחה", "success");
}

// --- Audio Visualization Logic ---
function startVisualizer(stream) {
    const canvas = document.getElementById('visualizer');
    visualizerCanvasCtx = canvas.getContext('2d');
    
    // Init Audio Context
    if(!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    source.connect(analyser);
    
    visualizerDataArray = new Uint8Array(analyser.frequencyBinCount);
    
    // UI Update
    document.getElementById('micIconContainer').classList.add('hidden');
    canvas.classList.remove('hidden');
    
    drawVisualizer();
}

function stopVisualizer() {
    if(visualizerReqId) cancelAnimationFrame(visualizerReqId);
    document.getElementById('micIconContainer').classList.remove('hidden');
    document.getElementById('visualizer').classList.add('hidden');
}

function drawVisualizer() {
    visualizerReqId = requestAnimationFrame(drawVisualizer);
    
    analyser.getByteFrequencyData(visualizerDataArray);
    
    const canvas = document.getElementById('visualizer');
    const width = canvas.width;
    const height = canvas.height;
    
    visualizerCanvasCtx.clearRect(0, 0, width, height);
    
    const barWidth = (width / visualizerDataArray.length) * 2.5;
    let barHeight;
    let x = 0;
    
    // Styling
    const isDark = document.documentElement.classList.contains('dark');
    
    for(let i = 0; i < visualizerDataArray.length; i++) {
        barHeight = visualizerDataArray[i] / 2;
        
        // Gradient color
        const r = barHeight + (25 * (i/visualizerDataArray.length));
        const g = 50;
        const b = 200;
        
        visualizerCanvasCtx.fillStyle = `rgb(${r},${g},${b})`;
        visualizerCanvasCtx.fillRect(x, height - barHeight, barWidth, barHeight);
        
        x += barWidth + 1;
    }
}

// Recording
async function toggleRecording(e) {
    e.stopPropagation();
    const btn = document.getElementById('recordBtn');
    const txt = document.getElementById('recordText');

    if(!mediaRecorder || mediaRecorder.state === 'inactive') {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Start Visualizer
            startVisualizer(stream);

            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/wav' });
                const file = new File([blob], "הקלטה_" + new Date().toLocaleTimeString().replace(/:/g,'-') + ".wav", { type: "audio/wav" });
                handleFile(file);
                stream.getTracks().forEach(t => t.stop());
                stopVisualizer();
            };
            mediaRecorder.start();
            btn.classList.add('border-red-500');
            txt.innerText = "עצור הקלטה";
            showToast("הקלטה החלה", "error"); // Red for recording
        } catch(err) { 
            showToast("גישה למיקרופון נדחתה", "error"); 
        }
    } else {
        mediaRecorder.stop();
        btn.classList.remove('border-red-500');
        txt.innerText = "התחל להקליט";
        showToast("הקלטה הסתיימה", "success");
    }
}

// Models
async function fetchModels() {
    const key = document.getElementById('apiKey').value;
    const btn = document.getElementById('loadModelsBtn');
    const select = document.getElementById('modelSelect');
    
    if(!key) { showToast("חסר מפתח API", "error"); return; }
    localStorage.setItem('gemini_api_key', key);
    
    btn.classList.add('animate-spin');
    try {
        const res = await fetch(BASE_URL + "/v1beta/models?key=" + key);
        const data = await res.json();
        if(data.error) throw new Error(data.error.message);
        
        select.innerHTML = "";
        const models = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
        models.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.name.replace('models/', '');
            opt.text = m.displayName;
            select.appendChild(opt);
        });
        
        // Auto select best
        const best = models.find(m => m.name.includes('gemini-1.5-pro')) || models[0];
        if(best) select.value = best.name.replace('models/', '');
        
        showToast("מודלים נטענו בהצלחה", "success");
        
    } catch(e) { showToast("שגיאה בטעינת מודלים: " + e.message, "error"); }
    finally { btn.classList.remove('animate-spin'); }
}

// Processing
async function runTranscriptionProcess() {
    const key = document.getElementById('apiKey').value;
    const model = document.getElementById('modelSelect').value;
    const file = selectedFile;
    const prompt = document.getElementById('promptInput').value;
    const context = document.getElementById('contextInput').value;
    const temp = document.getElementById('tempInput').value;
    const speakers = document.getElementById('speakerCount').value;

    if(!key || !model || !file) { showToast("נא למלא את כל השדות ולהעלות קובץ", "warning"); return; }
    
    localStorage.setItem('gemini_api_key', key);
    
    // UI Updates
    document.getElementById('runBtn').disabled = true;
    document.getElementById('runBtn').classList.add('opacity-50');
    document.getElementById('processSection').classList.remove('hidden');
    
    const statusText = document.getElementById('statusText');
    const progressBar = document.getElementById('progressBar');
    
    abortController = new AbortController();
    const signal = abortController.signal;

    try {
        // Step 1: Upload
        statusText.innerText = "מעלה קובץ לשרתי גוגל...";
        progressBar.style.width = "30%";
        
        const fingerprint = file.name + "_" + file.size;
        let fileUri = null;
        
        // Upload Init
        const initRes = await fetch(BASE_URL + "/upload/v1beta/files?key=" + key, {
            method: 'POST',
            headers: {
                'X-Goog-Upload-Protocol': 'resumable',
                'X-Goog-Upload-Command': 'start',
                'X-Goog-Upload-Header-Content-Length': file.size,
                'X-Goog-Upload-Header-Content-Type': file.type,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ file: { display_name: file.name } }),
            signal
        });
        
        if(!initRes.ok) throw new Error("Upload Init Failed");
        const uploadUrl = initRes.headers.get('X-Goog-Upload-URL');
        
        await fetch(uploadUrl, {
            method: 'POST',
            headers: { 'X-Goog-Upload-Command': 'upload, finalize', 'X-Goog-Upload-Offset': '0', 'Content-Type': file.type },
            body: file,
            signal
        }).then(async r => {
            const d = await r.json();
            fileUri = d.file.uri;
        });

        // Step 2: Wait for processing
        statusText.innerText = "מעבד מדיה...";
        progressBar.style.width = "60%";
        
        let state = "PROCESSING";
        while(state === "PROCESSING") {
            await new Promise(r => setTimeout(r, 2000));
            const stateRes = await fetch(fileUri + "?key=" + key);
            const stateData = await stateRes.json();
            state = stateData.state;
            if(state === "FAILED") throw new Error("Google Processing Failed");
        }

        // Step 3: Generate
        statusText.innerText = "מתמלל...";
        progressBar.style.width = "80%";
        
        let systemPrompt = `Context: ${context}.\n`;
        if(speakers) systemPrompt += `Speakers: ${speakers}.\n`;
        systemPrompt += `Task: ${prompt || "Transcribe the audio."}`;

        const genRes = await fetch(BASE_URL + "/v1beta/models/" + model + ":generateContent?key=" + key, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: systemPrompt }, { file_data: { mime_type: file.type, file_uri: fileUri } }] }],
                generationConfig: { temperature: parseFloat(temp) }
            }),
            signal
        });
        
        const genData = await genRes.json();
        if(genData.error) throw new Error(genData.error.message);
        
        const transcript = genData.candidates[0].content.parts[0].text;
        
        // Finish
        progressBar.style.width = "100%";
        statusText.innerText = "הושלם!";
        showToast("תמלול הסתיים בהצלחה!", "success");
        
        // Format & Save
        const formatted = transcript.split('\n').map(l => l.trim() ? `<p>${l}</p>` : '<br>').join('');
        document.getElementById('currentFileName').innerText = file.name;
        document.getElementById('outputArea').innerHTML = formatted;
        
        currentDocId = await saveToDB(file.name, formatted);
        
        setTimeout(() => {
            switchTab('editor');
            document.getElementById('processSection').classList.add('hidden');
            progressBar.style.width = "0%";
            document.getElementById('runBtn').disabled = false;
            document.getElementById('runBtn').classList.remove('opacity-50');
        }, 1000);

    } catch(e) {
        if(e.name !== 'AbortError') showToast("שגיאה: " + e.message, "error");
        document.getElementById('runBtn').disabled = false;
        document.getElementById('runBtn').classList.remove('opacity-50');
    }
}

function cancelProcess() {
    if(abortController) {
        abortController.abort();
        showToast("תהליך בוטל", "info");
    }
}

function copyToClipboard() {
    navigator.clipboard.writeText(document.getElementById('outputArea').innerText);
    showToast("הטקסט הועתק ללוח", "success");
}
function downloadText() {
    const blob = new Blob([document.getElementById('outputArea').innerText], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = document.getElementById('currentFileName').innerText + ".txt";
    a.click();
    showToast("הורדה החלה", "success");
}

// Init
window.onload = () => {
    initTheme();
    const k = localStorage.getItem('gemini_api_key');
    if(k) document.getElementById('apiKey').value = k;
};
</script>
</body>
</html>
