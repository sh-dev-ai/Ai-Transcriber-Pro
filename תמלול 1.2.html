<!DOCTYPE html>
<html class="light" dir="rtl" lang="he">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>מערכת תמלול Gemini 3.0 Pro</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

<script>
tailwind.config = {
darkMode: "class",
theme: {
extend: {
colors: {
"primary": "#0b60d0",
"background-light": "#fafaff",
"background-dark": "#17191c",
"surface-tonal": "#f0f4f9",
},
fontFamily: { "display": ["Heebo", "Manrope", "sans-serif"] },
},
},
}
</script>
<style>
body { font-family: "Heebo", "Manrope", sans-serif; }
.material-symbols-outlined { font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24; }
@keyframes pulse-blue {
0%, 100% { opacity: 1; }
50% { opacity: .5; }
}
.animate-pulse-custom { animation: pulse-blue 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
.dashed-border {
background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23333' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
border-radius: 12px;
}
#hiddenFileInput { display: none; }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#0d131c] dark:text-slate-50 min-h-screen transition-colors duration-200">

<header class="sticky top-0 z-50 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-[#e7ecf4] dark:border-slate-800 px-6 lg:px-20 py-4">
<div class="max-w-[1200px] mx-auto flex items-center justify-between">
<div class="flex items-center gap-4">
<div class="bg-primary p-2 rounded-lg text-white">
<span class="material-symbols-outlined text-2xl">settings_voice</span>
</div>
<div class="flex flex-col">
<h1 class="text-xl font-extrabold tracking-tight leading-none">Gemini Transcriber</h1>
<span class="text-xs text-[#496d9c] dark:text-slate-400 font-medium">כולל תמיכה במקורות מידע</span>
</div>
<div class="mr-4 px-2.5 py-0.5 rounded-full bg-primary/10 text-primary text-xs font-bold border border-primary/20">בטא</div>
</div>
</div>
</header>

<main class="max-w-[1000px] mx-auto px-6 py-10 space-y-8">

<div class="space-y-2">
<h2 class="text-3xl font-black text-[#0d131c] dark:text-white">לוח בקרה חכם</h2>
<p class="text-[#496d9c] dark:text-slate-400">העלה קובץ, הזן חומרי רקע לדיוק מירבי, וקבל תמלול מקצועי.</p>
</div>

<section class="bg-white dark:bg-slate-900 rounded-xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-[#e7ecf4] dark:border-slate-800 overflow-hidden">
<div class="p-6 md:p-8 space-y-6">
<div class="flex items-center gap-3 border-b border-slate-100 dark:border-slate-800 pb-4">
<span class="material-symbols-outlined text-primary">key</span>
<h3 class="text-lg font-bold">הגדרות חיבור</h3>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
<div class="md:col-span-1">
<label class="block mb-2 text-sm font-bold text-slate-700 dark:text-slate-300">מפתח API</label>
<div class="relative">
<input id="apiKey" class="w-full bg-surface-tonal dark:bg-slate-800 border-none rounded-lg h-12 px-4 focus:ring-2 focus:ring-primary/50 transition-all" placeholder="הזן מפתח API כאן" type="password"/>
<span onclick="toggleKeyVisibility()" class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer text-sm hover:text-primary">visibility</span>
</div>
</div>
<div class="md:col-span-1">
<label class="block mb-2 text-sm font-bold text-slate-700 dark:text-slate-300">בחר מודל</label>
<select id="modelSelect" class="w-full bg-surface-tonal dark:bg-slate-800 border-none rounded-lg h-12 px-4 focus:ring-2 focus:ring-primary/50 appearance-none">
<option value="" disabled selected>יש לטעון מודלים תחילה...</option>
</select>
</div>
<div>
<button onclick="fetchModels()" id="loadModelsBtn" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold h-12 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg">
<span class="material-symbols-outlined">sync</span>
<span>טען מודלים</span>
</button>
</div>
</div>
</div>
</section>

<section class="space-y-4">
<input type="file" id="hiddenFileInput" accept="audio/*,video/*">
<div id="dropZone" class="dashed-border bg-surface-tonal/50 dark:bg-slate-800/30 p-12 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-surface-tonal dark:hover:bg-slate-800/50 transition-all group border-2 border-dashed border-slate-300 dark:border-slate-700">
<div class="size-20 bg-primary/10 rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
<span class="material-symbols-outlined text-primary text-4xl">cloud_upload</span>
</div>
<h3 id="fileNameDisplay" class="text-xl font-black mb-2">גרור לכאן קובץ אודיו או וידאו</h3>
<p class="text-[#496d9c] dark:text-slate-400 max-w-sm">MP4, MP3, WAV, MKV - תומך בקבצים גדולים עד 2GB</p>
<div class="mt-8">
<button onclick="document.getElementById('hiddenFileInput').click()" class="bg-white dark:bg-slate-700 px-6 py-2.5 rounded-lg text-sm font-bold shadow-sm border border-slate-200 dark:border-slate-600 hover:bg-slate-50 transition">בחר קובץ מהמחשב</button>
</div>
</div>
</section>

<section class="space-y-4 bg-yellow-50 dark:bg-slate-800/50 p-6 rounded-xl border border-yellow-100 dark:border-slate-700">
<div class="flex items-center gap-2 px-1">
<span class="material-symbols-outlined text-yellow-600">menu_book</span>
<h3 class="font-bold text-lg text-slate-800 dark:text-slate-200">חומרי עזר ומילון מונחים (אופציונלי)</h3>
</div>
<p class="text-sm text-slate-500 px-1">כאן ניתן להדביק רשימת שמות, מונחים מקצועיים, או סיכום קצר שיעזור למודל להבין את ההקשר ולדייק בתמלול.</p>
<textarea id="contextInput" class="w-full bg-white dark:bg-slate-900 border border-[#cedae8] dark:border-slate-700 rounded-xl p-4 min-h-[80px] focus:ring-2 focus:ring-yellow-500/50 text-right font-medium text-sm" placeholder="למשל: הדוברים הם יוסי ודני. השיחה עוסקת בפרויקט 'שחקים'. מונחים טכניים: API, React, Node.js..."></textarea>
</section>

<section class="space-y-4">
<div class="flex items-center gap-2 px-1">
<span class="material-symbols-outlined text-primary">psychology</span>
<h3 class="font-bold text-lg">הנחיה למודל</h3>
</div>
<textarea id="promptInput" class="w-full bg-white dark:bg-slate-900 border border-[#cedae8] dark:border-slate-800 rounded-xl p-5 min-h-[100px] focus:ring-2 focus:ring-primary/50 text-right font-medium" placeholder="לדוגמה: תמלל את הסרטון וצור סיכום של הנקודות העיקריות בשפה רשמית. הקפד לזהות דוברים שונים."></textarea>

<button id="runBtn" onclick="runTranscriptionProcess()" class="w-full bg-primary hover:bg-primary/90 text-white text-lg font-black h-14 rounded-xl shadow-xl shadow-primary/20 transition-all flex items-center justify-center gap-3">
<span class="material-symbols-outlined text-2xl">play_circle</span>
<span>התחל תמלול עכשיו</span>
</button>
</section>

<section id="processSection" class="bg-white dark:bg-slate-900 rounded-xl p-8 border border-[#e7ecf4] dark:border-slate-800 opacity-50 pointer-events-none transition-opacity duration-300">
<div class="relative flex justify-between items-center max-w-[700px] mx-auto">
<div class="absolute top-1/2 left-0 right-0 h-1 bg-slate-100 dark:bg-slate-800 -translate-y-1/2 z-0"></div>
<div id="progressBar" class="absolute top-1/2 right-0 w-0 h-1 bg-primary -translate-y-1/2 z-0 transition-all duration-700"></div>

<div class="relative z-10 flex flex-col items-center gap-3">
<div id="step1-icon" class="step-icon size-12 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center border-2 border-slate-200"><span class="material-symbols-outlined">cloud_upload</span></div>
<span id="step1-text" class="text-sm font-bold text-slate-400">העלאה לענן</span>
</div>

<div class="relative z-10 flex flex-col items-center gap-3">
<div id="step2-icon" class="step-icon size-12 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center border-2 border-slate-200"><span class="material-symbols-outlined">settings_motion_mode</span></div>
<span id="step2-text" class="text-sm font-bold text-slate-400">עיבוד קובץ</span>
</div>

<div class="relative z-10 flex flex-col items-center gap-3">
<div id="step3-icon" class="step-icon size-12 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center border-2 border-slate-200"><span class="material-symbols-outlined">description</span></div>
<span id="step3-text" class="text-sm font-bold text-slate-400">יצירת תמלול</span>
</div>
</div>
<p id="statusText" class="text-center mt-6 text-primary font-bold text-sm h-6"></p>
</section>

<section class="space-y-4">
<div class="flex items-center justify-between px-1">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-primary">analytics</span>
<h3 class="font-bold text-lg">תוצאה</h3>
</div>
<div class="flex gap-2">
<button onclick="downloadText()" class="flex items-center gap-2 bg-surface-tonal dark:bg-slate-800 px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
<span class="material-symbols-outlined text-base">download</span>
<span>הורד TXT</span>
</button>
<button onclick="copyToClipboard()" class="flex items-center gap-2 bg-primary/10 text-primary px-4 py-2 rounded-lg text-sm font-bold hover:bg-primary/20 transition-colors">
<span class="material-symbols-outlined text-base">content_copy</span>
<span>העתק</span>
</button>
</div>
</div>
<div class="bg-white dark:bg-slate-900 border border-[#e7ecf4] dark:border-slate-800 rounded-xl p-8 shadow-sm">
<div id="outputArea" class="prose dark:prose-invert max-w-none text-slate-700 dark:text-slate-300 leading-relaxed text-right space-y-4 whitespace-pre-wrap">
<p class="text-slate-400 italic">התוצאה תופיע כאן בסיום התהליך...</p>
</div>
</div>
</section>
</main>

<footer class="mt-10 py-8 border-t border-[#e7ecf4] dark:border-slate-800 text-center text-sm text-[#496d9c] dark:text-slate-500">
<p dir="ltr">© 2026 Gemini Transcriber. Based on Google AI API.</p>
</footer>

<script>
const BASE_URL = "https://generativelanguage.googleapis.com";

// --- זיכרון קבצים ---
let fileCache = JSON.parse(localStorage.getItem('gemini_file_cache') || '{}');

// UI Logic
function toggleKeyVisibility() {
const input = document.getElementById('apiKey');
input.type = input.type === "password" ? "text" : "password";
}

// טעינת מפתח API שמור
window.onload = function() {
const savedKey = localStorage.getItem('gemini_api_key');
if (savedKey) document.getElementById('apiKey').value = savedKey;
};

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('hiddenFileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-primary/5', 'border-primary'); });
dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('bg-primary/5', 'border-primary'); });
dropZone.addEventListener('drop', (e) => {
e.preventDefault();
dropZone.classList.remove('bg-primary/5', 'border-primary');
if(e.dataTransfer.files.length) {
fileInput.files = e.dataTransfer.files;
handleFileSelect();
}
});

fileInput.addEventListener('change', handleFileSelect);
function handleFileSelect() {
if(fileInput.files.length) {
const f = fileInput.files[0];
document.getElementById('fileNameDisplay').textContent = "נבחר: " + f.name;
document.getElementById('fileNameDisplay').classList.add('text-primary');
}
}

function setStep(stepNum, statusMsg = "") {
const section = document.getElementById('processSection');
section.classList.remove('opacity-50', 'pointer-events-none');
document.getElementById('statusText').textContent = statusMsg;
const bar = document.getElementById('progressBar');
const colors = { activeBg: 'bg-primary', activeText: 'text-white', inactiveBg: 'bg-slate-100', inactiveText: 'text-slate-400' };

[1, 2, 3].forEach(i => {
const icon = document.getElementById("step" + i + "-icon");
const text = document.getElementById("step" + i + "-text");
if (i <= stepNum) {
icon.className = "step-icon size-12 rounded-full " + colors.activeBg + " " + colors.activeText + " flex items-center justify-center shadow-lg shadow-primary/30 transition-all duration-500";
text.className = "text-sm font-bold " + colors.activeBg.replace('bg-', 'text-');
if (i === stepNum) icon.classList.add('animate-pulse-custom');
else icon.classList.remove('animate-pulse-custom');
} else {
icon.className = "step-icon size-12 rounded-full " + colors.inactiveBg + " " + colors.inactiveText + " flex items-center justify-center border-2 border-slate-200";
text.className = "text-sm font-bold " + colors.inactiveText;
}
});
if(stepNum === 1) bar.style.width = "25%";
if(stepNum === 2) bar.style.width = "75%";
if(stepNum === 3) bar.style.width = "100%";
}

// --- Core API Logic ---

async function fetchModels() {
const key = document.getElementById('apiKey').value;
const btn = document.getElementById('loadModelsBtn');
const select = document.getElementById('modelSelect');
if (!key) { alert("יש להזין מפתח API"); return; }

localStorage.setItem('gemini_api_key', key);
btn.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> טוען...';
btn.disabled = true;

try {
const response = await fetch(BASE_URL + "/v1beta/models?key=" + key);
const data = await response.json();
if (data.error) throw new Error(data.error.message);
select.innerHTML = "";
const models = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
models.sort((a, b) => b.name.localeCompare(a.name));
models.forEach(m => {
const cleanName = m.name.replace('models/', '');
const opt = document.createElement('option');
opt.value = cleanName;
opt.text = m.displayName + " (" + cleanName + ")";
select.appendChild(opt);
});
const bestModel = models.find(m => m.name.includes('gemini-2.0-flash') || m.name.includes('gemini-1.5-pro')) || models[0];
if(bestModel) select.value = bestModel.name.replace('models/', '');
btn.innerHTML = '<span class="material-symbols-outlined">check</span> נטען';
btn.className = "w-full bg-green-600 text-white font-bold h-12 rounded-lg flex items-center justify-center gap-2";
} catch (e) {
alert("שגיאה: " + e.message);
btn.innerHTML = "נסה שוב";
btn.disabled = false;
}
}

// פונקציה לבדיקה אם קובץ עדיין קיים בשרת גוגל
async function checkGoogleFileStatus(uri, key) {
try {
const res = await fetch(uri + "?key=" + key);
if (!res.ok) return null;
const data = await res.json();
return data.state;
} catch (e) { return null; }
}

async function runTranscriptionProcess() {
const key = document.getElementById('apiKey').value;
const model = document.getElementById('modelSelect').value;
const file = fileInput.files[0];
const prompt = document.getElementById('promptInput').value;
const context = document.getElementById('contextInput').value;

if (!key || !model || !file) {
alert("אנא וודא שהזנת מפתח API, בחרת מודל והעלית קובץ.");
return;
}

localStorage.setItem('gemini_api_key', key);
const runBtn = document.getElementById('runBtn');
runBtn.disabled = true;
runBtn.classList.add('opacity-50', 'cursor-not-allowed');
document.getElementById('outputArea').innerHTML = "";

// יצירת חתימה לקובץ
const fingerprint = file.name + "_" + file.size + "_" + file.lastModified;
let fileUri = null;

try {
// בדיקת זיכרון (Cache)
if (fileCache[fingerprint]) {
setStep(1, "בודק אם הקובץ קיים בשרתי גוגל...");
const status = await checkGoogleFileStatus(fileCache[fingerprint], key);
if (status === "ACTIVE") {
fileUri = fileCache[fingerprint];
setStep(2, "הקובץ נמצא בשרת. מדלג על העלאה...");
} else if (status === "PROCESSING") {
fileUri = fileCache[fingerprint];
setStep(2, "הקובץ בעיבוד בשרת. ממתין...");
await waitForActive(fileUri, key);
}
}

if (!fileUri) {
setStep(1, "מעלה את הקובץ לשרתי גוגל...");
fileUri = await uploadFile(file, key);

// שמירה בזיכרון
fileCache[fingerprint] = fileUri;
localStorage.setItem('gemini_file_cache', JSON.stringify(fileCache));

setStep(2, "הקובץ התקבל. ממתין לעיבוד...");
await waitForActive(fileUri, key);
}

setStep(3, "מנתח את התוכן וכותב תמלול...");
const text = await generateContent(model, fileUri, file.type, prompt, context, key);

setStep(3, "התהליך הושלם!");
document.getElementById('outputArea').innerText = text;

} catch (e) {
document.getElementById('statusText').innerText = "שגיאה: " + e.message;
document.getElementById('statusText').classList.add('text-red-500');
alert("התהליך נכשל: " + e.message);
} finally {
runBtn.disabled = false;
runBtn.classList.remove('opacity-50', 'cursor-not-allowed');
}
}

async function uploadFile(file, key) {
const initRes = await fetch(BASE_URL + "/upload/v1beta/files?key=" + key, {
method: 'POST',
headers: {
'X-Goog-Upload-Protocol': 'resumable',
'X-Goog-Upload-Command': 'start',
'X-Goog-Upload-Header-Content-Length': file.size,
'X-Goog-Upload-Header-Content-Type': file.type,
'Content-Type': 'application/json'
},
body: JSON.stringify({ file: { display_name: file.name } })
});
if (!initRes.ok) throw new Error("Init failed");
const uploadUrl = initRes.headers.get('X-Goog-Upload-URL');
const uploadRes = await fetch(uploadUrl, {
method: 'POST',
headers: { 'X-Goog-Upload-Command': 'upload, finalize', 'X-Goog-Upload-Offset': '0', 'Content-Type': file.type },
body: file
});
const result = await uploadRes.json();
return result.file.uri;
}

async function waitForActive(fileUri, key) {
let state = "PROCESSING";
while (state === "PROCESSING") {
await new Promise(r => setTimeout(r, 3000));
const res = await fetch(fileUri + "?key=" + key);
const data = await res.json();
state = data.state;
if (state === "FAILED") throw new Error("Server processing failed");
}
}

async function generateContent(modelName, fileUri, mimeType, prompt, context, key) {
const url = BASE_URL + "/v1beta/models/" + modelName + ":generateContent?key=" + key;

let finalPromptText = prompt;
if (context && context.trim() !== "") {
finalPromptText = "[CONTEXT]:\n" + context + "\n\n[PROMPT]:\n" + prompt;
}

const payload = {
contents: [{
parts: [
{ text: finalPromptText },
{ file_data: { mime_type: mimeType, file_uri: fileUri } }
]
}]
};

const res = await fetch(url, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload)
});

const data = await res.json();
if (data.error) throw new Error(data.error.message);
return data.candidates[0].content.parts[0].text;
}

function copyToClipboard() {
const text = document.getElementById('outputArea').innerText;
navigator.clipboard.writeText(text).then(() => alert("הטקסט הועתק!"));
}
function downloadText() {
const text = document.getElementById('outputArea').innerText;
const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
const a = document.createElement("a");
a.href = URL.createObjectURL(blob);
a.download = "transcription.txt";
a.click();
}
</script>

</body>
</html>